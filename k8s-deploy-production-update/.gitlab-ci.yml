spec:
  inputs:
    service:
       description: "The Service that should be updated and promoted to prod"
    version:
       description: "The Version that the Service is being updated to"

---
stages:
   - prod-update

kube-prod-update:
    stage: prod-update
    image: bitnami/kubectl:latest
    script:
        - ls
        - SERVICE=$(echo "$[[ inputs.service ]]")
        - VERSION=$(echo "$[[ inputs.version ]]")
        # update images
        - | 
           sed -i "s#image: .*#image: `kubectl -n staging get deployment -o jsonpath='{.items[*].spec.template.spec.containers[0].image}' --field-selector=metadata.name=$SERVICE`#" $SERVICE.yml
        # update version
        - | 
           sed -i "s#  version: v1#  version: $VERSION#" $SERVICE.yml
        # update name
        - | 
           sed -i "s#  name: $SERVICE-v1#  name: $SERVICE-$VERSION#" $SERVICE.yml
        - |
           kubectl apply -f $SERVICE.yml