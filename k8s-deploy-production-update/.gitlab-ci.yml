spec:
  inputs:
    SERVICE:
       description: "The Service that should be updated and promoted to prod"
    VERSION:
       description: "The Version that the Service is being updated to"

---
kube-prod-update:
    needs:
      - $[[ inputs.service ]]
      - $[[ inputs.version ]]
    stage: prod-update
    image: bitnami/kubectl:latest
    script:
        # copy original service description to a temporary one.
        - "cp $[[ inputs.service ]].yml $[[ inputs.service ]]-$[[ inputs.version ]].yml"
        # update images
        - | 
           "sed -i \"s#image: .*#image: `kubectl -n staging get deployment -o jsonpath='{.items[*].spec.template.spec.containers[0].image}' --field-selector=metadata.name=$[[ inputs.service ]]`#\" $[[ inputs.service ]]-$[[ inputs.version ]].yml"
        # update version
        - | 
           "sed -i \"s#  version: v1#  version: $VERSION#\" $[[ inputs.service ]]-$[[ inputs.version ]].yml"
        # update name
        - | 
           "sed -i \"s#  name: $[[ inputs.service ]]-v1#  name: $[[ inputs.service ]]-$[[ inputs.version ]]#\" $[[ inputs.service ]]-$[[ inputs.version ]].yml"
        - |
           "kubectl apply -f $[[ inputs.service ]]-$[[ inputs.version ]].yml"